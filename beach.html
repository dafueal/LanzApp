document.addEventListener('DOMContentLoaded', () => {
    // --- Configuración de Firebase (¡¡REEMPLAZA CON TUS VALORES!!) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAvtAh8dWsqLXLwtohdHJT4bm2fkH73Tg4",
      authDomain: "lanzapp-10b86.firebaseapp.com",
      projectId: "lanzapp-10b86",
      storageBucket: "lanzapp-10b86.firebasestorage.app",
      messagingSenderId: "977850801417",
      appId: "1:977850801417:web:9c086bc6f85a6e66f447d8"
    };

    // --- Variables Globales y Referencias a Elementos ---
    let db; // Instancia Firestore
    const NOTES_COLLECTION = 'userBeachNotes';
    const params = new URLSearchParams(window.location.search);
    const beachId = params.get('id');
    let currentUserId = null;
    let beachData = null;
    let currentNoteDocId = null;

    const beachContentDiv = document.getElementById('beach-content');
    const beachNameEl = document.getElementById('beach-detail-name');
    const beachPhotoEl = document.getElementById('beach-detail-photo');
    const beachDescEl = document.getElementById('beach-detail-description');
    const beachCharacteristicsDiv = document.getElementById('beach-detail-characteristics');
    const beachSandEl = document.getElementById('beach-detail-sand');
    const beachConcEl = document.getElementById('beach-detail-concurrency');
    const beachWaterEl = document.getElementById('beach-detail-water');
    const beachAmenitiesEl = document.getElementById('beach-detail-amenities');
    const beachAccessibilityEl = document.getElementById('beach-detail-accessibility');
    const errorPlaceholder = document.getElementById('error-placeholder');
    const currentUserIdSpan = document.getElementById('current-user-id');
    const notesSectionWrapper = document.getElementById('notes-section-wrapper');
    const notesContentDiv = document.getElementById('notes-content');
    const userNotesTextarea = document.getElementById('user-notes');
    const saveNotesButton = document.getElementById('save-notes-button');
    const notesStatusSpan = document.getElementById('notes-status');
    const notesDisabledMessage = document.getElementById('notes-disabled-message');

    // --- Inicialización Principal ---
    function initializeApp() {
        console.log("Iniciando beach-detail.js...");
        if (!beachId) {
            showError("No se especificó un ID de playa en la URL.");
            return;
        }
        console.log(`ID de Playa: ${beachId}`);

        // Inicializar Firebase
        try {
            if (typeof firebase === 'undefined' || !firebase.initializeApp) {
                 throw new Error("SDK de Firebase no cargado correctamente.");
            }
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase inicializado correctamente.");
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
            showError("No se pudo conectar con el servicio de notas (Firebase). Es posible que necesites configurar tus credenciales en beach-detail.js.");
            disableNotesCompletely("Firebase no disponible.");
            // Aún intentaremos cargar detalles de la playa desde JSON
            loadBeachDetailsOnly();
            return; // No continuar con la lógica de notas si Firebase falla
        }

        // Obtener User ID de sessionStorage
        currentUserId = sessionStorage.getItem('beachExplorerUserId');
        console.log(`ID de Usuario (sessionStorage): ${currentUserId}`);

        if (currentUserId) {
            activateNotesSection();
            loadBeachDetailsAndNotes(); // Cargar playa y luego notas
        } else {
            deactivateNotesSection();
            loadBeachDetailsOnly(); // Cargar solo playa
        }
    }

    // --- Lógica de Activación/Desactivación de Notas ---
    function activateNotesSection() {
        if (!currentUserIdSpan || !notesDisabledMessage || !notesContentDiv || !userNotesTextarea || !saveNotesButton) return;
        currentUserIdSpan.textContent = currentUserId;
        notesDisabledMessage.classList.add('hidden');
        notesContentDiv.classList.remove('hidden');
        userNotesTextarea.disabled = false;
        userNotesTextarea.placeholder = "Escribe tus notas aquí..."; // Placeholder útil
        saveNotesButton.disabled = false;
        notesSectionWrapper.classList.remove('hidden'); // Asegurar que el wrapper es visible
    }

    function deactivateNotesSection() {
         if (!currentUserIdSpan || !notesDisabledMessage || !notesContentDiv || !userNotesTextarea || !saveNotesButton) return;
         currentUserIdSpan.textContent = "Usuario no identificado";
         notesDisabledMessage.classList.remove('hidden');
         notesContentDiv.classList.add('hidden');
         userNotesTextarea.disabled = true;
         userNotesTextarea.placeholder = "Introduce un ID en la página del mapa para activar las notas...";
         saveNotesButton.disabled = true;
         notesSectionWrapper.classList.remove('hidden'); // El wrapper puede ser visible para mostrar el mensaje
    }

     function disableNotesCompletely(reason = "El servicio de notas no está disponible.") {
         if (!notesSectionWrapper || !notesContentDiv || !notesDisabledMessage) return;
         notesSectionWrapper.classList.remove('hidden');
         notesContentDiv.classList.add('hidden');
         notesDisabledMessage.textContent = reason;
         notesDisabledMessage.classList.remove('hidden');
         if (currentUserIdSpan) currentUserIdSpan.textContent = "-"; // Indicar no disponible
     }


    // --- Carga de Datos de Playa (desde JSON) ---
     function loadBeachDetailsOnly() {
         console.log("Cargando solo detalles de la playa...");
         fetch('beaches.json')
            .then(response => {
                if (!response.ok) throw new Error(`Error HTTP cargando beaches.json: ${response.status}`);
                return response.json();
            })
            .then(allBeaches => {
                beachData = allBeaches.find(b => b.id === beachId);
                if (beachData) {
                    displayBeachDetails(beachData);
                } else {
                    showError(`No se encontró ninguna playa con el ID "${beachId}".`);
                }
            })
            .catch(handleFetchError);
     }
     function loadBeachDetailsAndNotes() {
         console.log("Cargando detalles de playa y notas...");
         fetch('beaches.json')
            .then(response => {
                if (!response.ok) throw new Error(`Error HTTP cargando beaches.json: ${response.status}`);
                return response.json();
            })
            .then(allBeaches => {
                beachData = allBeaches.find(b => b.id === beachId);
                if (beachData) {
                    displayBeachDetails(beachData);
                    // Llamar a cargar notas DESPUÉS de mostrar detalles
                    if (currentUserId && db) { // Solo si hay ID y Firebase está listo
                         fetchNotesFromFirestore();
                    }
                } else {
                    showError(`No se encontró ninguna playa con el ID "${beachId}".`);
                }
            })
            .catch(handleFetchError);
     }

    // --- Mostrar Detalles de Playa en el DOM ---
    function displayBeachDetails(beach) {
         console.log("Mostrando detalles para:", beach.name);
         document.title = `Detalles: ${beach.name || 'Playa'}`;
         beachNameEl.textContent = beach.name || 'Nombre no disponible';
         if (beach.photoUrl) {
             beachPhotoEl.src = beach.photoUrl;
             beachPhotoEl.alt = `Foto de ${beach.name || 'la playa'}`;
             beachPhotoEl.style.display = 'block'; // Usar display block en lugar de quitar estilo
         } else {
             beachPhotoEl.style.display = 'none';
         }
         beachDescEl.textContent = beach.description || 'Descripción no disponible.';

         const characteristics = beach.characteristics || {};
         beachSandEl.innerHTML = characteristics.sandType ? `<strong>Arena:</strong> ${characteristics.sandType}` : '';
         beachConcEl.innerHTML = characteristics.concurrency ? `<strong>Concurrencia:</strong> ${characteristics.concurrency}` : '';
         beachWaterEl.innerHTML = characteristics.waterQuality ? `<strong>Calidad del Agua:</strong> ${characteristics.waterQuality}` : '';
         beachAmenitiesEl.innerHTML = characteristics.amenities ? `<strong>Servicios:</strong> ${characteristics.amenities}` : '';
         beachAccessibilityEl.innerHTML = characteristics.accessibility ? `<strong>Accesibilidad:</strong> ${characteristics.accessibility}` : '';

         // Ocultar toda la sección si no hay características
         if (Object.values(characteristics).every(val => !val)) { // Si todos los valores son vacíos/null/undefined
             beachCharacteristicsDiv.style.display = 'none';
             console.log("Ocultando sección de características (vacía).");
         } else {
              beachCharacteristicsDiv.style.display = 'block'; // Asegurar que sea visible si hay datos
         }

         beachContentDiv.classList.remove('hidden'); // Mostrar contenido principal
         errorPlaceholder.classList.add('hidden'); // Ocultar errores previos
    }


    // --- Funciones de Notas con Firestore ---
    async function fetchNotesFromFirestore() {
        if (!currentUserId || !beachId || !db) {
             console.warn("fetchNotesFromFirestore: Faltan datos (userId, beachId o db)");
             return;
        }
        console.log(`Buscando notas para userId: ${currentUserId}, beachId: ${beachId}`);
        notesStatusSpan.textContent = 'Cargando notas...';
        notesStatusSpan.style.color = 'orange';
        userNotesTextarea.disabled = true;
        currentNoteDocId = null;

        try {
            const querySnapshot = await db.collection(NOTES_COLLECTION)
                .where("userId", "==", currentUserId)
                .where("beachId", "==", beachId)
                .limit(1)
                .get();

            if (querySnapshot.empty) {
                console.log("No se encontraron notas previas en Firestore.");
                userNotesTextarea.value = '';
                notesStatusSpan.textContent = 'No hay notas guardadas.';
                setTimeout(() => { if (notesStatusSpan.textContent === 'No hay notas guardadas.') notesStatusSpan.textContent = ''; }, 3000);
            } else {
                const doc = querySnapshot.docs[0];
                currentNoteDocId = doc.id;
                const notesText = doc.data().notesText || '';
                userNotesTextarea.value = notesText;
                console.log(`Notas cargadas desde Firestore (Doc ID: ${currentNoteDocId}).`);
                notesStatusSpan.textContent = 'Notas cargadas.';
                setTimeout(() => { if (notesStatusSpan.textContent === 'Notas cargadas.') notesStatusSpan.textContent = ''; }, 2000);
            }
        } catch (error) {
            console.error('Error al obtener notas de Firestore:', error);
            notesStatusSpan.textContent = 'Error al cargar notas.';
            notesStatusSpan.style.color = 'red';
            userNotesTextarea.value = 'Error al cargar las notas.';
        } finally {
            userNotesTextarea.disabled = false;
        }
    }

    async function saveNotesToFirestore() {
        if (!currentUserId || !beachId || !db) {
             console.warn("saveNotesToFirestore: Faltan datos (userId, beachId o db)");
             return;
        }

        const notesToSave = userNotesTextarea.value;
        console.log(`Guardando notas para userId: ${currentUserId}, beachId: ${beachId}`);
        saveNotesButton.disabled = true;
        notesStatusSpan.textContent = 'Guardando...';
        notesStatusSpan.style.color = 'orange';

        const noteData = {
            userId: currentUserId,
            beachId: beachId,
            notesText: notesToSave,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            let operation;
            if (currentNoteDocId) {
                // Actualizar documento existente
                console.log(`Actualizando documento Firestore: ${currentNoteDocId}`);
                const docRef = db.collection(NOTES_COLLECTION).doc(currentNoteDocId);
                operation = docRef.update(noteData);
            } else {
                // Crear nuevo documento
                console.log("Creando nuevo documento en Firestore.");
                // No necesitamos guardar la ref aquí si no la usamos después del add
                operation = db.collection(NOTES_COLLECTION).add(noteData);
                 // Si quisiéramos el ID nuevo inmediatamente (requiere await):
                 // const docRef = await db.collection(NOTES_COLLECTION).add(noteData);
                 // currentNoteDocId = docRef.id;
            }
            await operation; // Esperar a que la operación termine

            // Si la operación fue 'add', necesitamos volver a buscar para obtener el ID
            // si no usamos 'await' antes. O simplemente asumimos éxito.
            // Para simplicidad, no actualizaremos currentNoteDocId aquí si fue 'add'.
            // Se obtendrá la próxima vez que se carguen las notas.

            console.log("Notas guardadas/actualizadas correctamente.");
            notesStatusSpan.textContent = '¡Notas guardadas!';
            notesStatusSpan.style.color = 'green';
            setTimeout(() => { if (notesStatusSpan.textContent === '¡Notas guardadas!') notesStatusSpan.textContent = ''; }, 2500);

        } catch (error) {
            console.error('Error al guardar notas en Firestore:', error);
            notesStatusSpan.textContent = 'Error al guardar.';
            notesStatusSpan.style.color = 'red';
        } finally {
            saveNotesButton.disabled = false;
        }
    }

    // --- Funciones de Error ---
     function handleFetchError(error) {
        console.error('Error al cargar datos de beaches.json:', error);
        showError(`Ocurrió un error al cargar la información de la playa: ${error.message}`);
        disableNotesCompletely("Datos de playa no disponibles.");
     }
     function showError(message) {
         console.error("Mostrando Error:", message);
         if(beachContentDiv) beachContentDiv.classList.add('hidden');
         if(errorPlaceholder) {
             errorPlaceholder.textContent = message;
             errorPlaceholder.classList.remove('hidden');
         }
         document.title = "Error";
         // Opcional: Ocultar la sección de notas también
         if(notesSectionWrapper) notesSectionWrapper.classList.add('hidden');
     }

     // --- Event Listener para Guardar Notas ---
    if (saveNotesButton) {
        saveNotesButton.addEventListener('click', saveNotesToFirestore);
    } else {
         console.warn("Botón para guardar notas no encontrado.");
    }

    // --- Iniciar la aplicación ---
    initializeApp();

}); // Fin DOMContentLoaded
